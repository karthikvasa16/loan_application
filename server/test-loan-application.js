const axios = require('axios');\nconst FormData = require('form-data');\nconst fs = require('fs');\nconst path = require('path');\n\nconst API_BASE = 'http://localhost:5000/api';\n\n// Test data\nconst testApplication = {\n  type: {\n    loanType: 'abroad',\n    loanAmount: '2500000',\n    tenure: '10'\n  },\n  applicant: {\n    firstName: 'John',\n    lastName: 'Doe',\n    dateOfBirth: '1995-05-15',\n    gender: 'Male',\n    email: 'john.doe@example.com',\n    phone: '9876543210',\n    nationality: 'Indian',\n    maritalStatus: 'single'\n  },\n  academic: {\n    currentQualification: 'bachelor',\n    currentInstitution: 'ABC University',\n    percentage: '85%',\n    yearOfPassing: '2023',\n    targetCountry: 'usa',\n    targetUniversity: 'Stanford University',\n    courseLevel: 'postgraduate',\n    courseName: 'Master of Science in Computer Science',\n    courseDuration: '2',\n    intakeSession: 'fall-2024',\n    tuitionFee: '5000000'\n  },\n  financial: {\n    employmentStatus: 'employed',\n    annualIncome: '1200000',\n    employerName: 'Tech Corp',\n    workExperience: '3-5',\n    existingEMI: '25000',\n    creditCardOutstanding: '50000',\n    bankBalance: '500000',\n    investments: '200000',\n    propertyOwned: 'No'\n  },\n  family: {\n    fatherName: 'Robert Doe',\n    motherName: 'Jane Doe',\n    fatherOccupation: 'Engineer',\n    motherOccupation: 'Teacher',\n    fatherIncome: '800000',\n    motherIncome: '600000',\n    fatherPhone: '9876543211',\n    motherPhone: '9876543212',\n    dependents: '2',\n    coApplicantRequired: 'Yes',\n    coApplicantName: 'Robert Doe',\n    coApplicantRelation: 'father',\n    coApplicantIncome: '800000',\n    coApplicantPhone: '9876543211'\n  },\n  address: {\n    currentAddress: '123 Main Street',\n    currentAddress2: 'Sector 1',\n    city: 'Mumbai',\n    state: 'maharashtra',\n    pincode: '400001',\n    country: 'India',\n    residenceType: 'Owned',\n    sameAddress: 'Yes'\n  },\n  preview: {\n    termsAccepted: true\n  }\n};\n\nclass LoanApplicationTester {\n  constructor() {\n    this.token = null;\n    this.applicationId = null;\n  }\n\n  async login() {\n    try {\n      console.log('ğŸ” Logging in...');\n      const response = await axios.post(`${API_BASE}/auth/login`, {\n        email: 'student@kubera.gov.in',\n        password: 'password123'\n      });\n      \n      this.token = response.data.token;\n      console.log('âœ… Login successful');\n      return true;\n    } catch (error) {\n      console.error('âŒ Login failed:', error.response?.data?.error || error.message);\n      return false;\n    }\n  }\n\n  getHeaders() {\n    return {\n      'Authorization': `Bearer ${this.token}`,\n      'Content-Type': 'application/json'\n    };\n  }\n\n  async testCreateApplication() {\n    try {\n      console.log('\\nğŸ“ Testing application creation...');\n      const response = await axios.post(\n        `${API_BASE}/loans/applications`,\n        testApplication,\n        { headers: this.getHeaders() }\n      );\n      \n      this.applicationId = response.data.data.id;\n      console.log('âœ… Application created successfully');\n      console.log('   Application ID:', this.applicationId);\n      console.log('   Application Number:', response.data.data.applicationNumber);\n      return true;\n    } catch (error) {\n      console.error('âŒ Application creation failed:', error.response?.data?.message || error.message);\n      return false;\n    }\n  }\n\n  async testUpdateApplication() {\n    try {\n      console.log('\\nğŸ“ Testing application update...');\n      const updatedData = {\n        ...testApplication,\n        applicant: {\n          ...testApplication.applicant,\n          phone: '9876543299' // Updated phone\n        }\n      };\n      \n      const response = await axios.put(\n        `${API_BASE}/loans/applications/${this.applicationId}`,\n        updatedData,\n        { headers: this.getHeaders() }\n      );\n      \n      console.log('âœ… Application updated successfully');\n      return true;\n    } catch (error) {\n      console.error('âŒ Application update failed:', error.response?.data?.message || error.message);\n      return false;\n    }\n  }\n\n  async testDocumentUpload() {\n    try {\n      console.log('\\nğŸ“„ Testing document upload...');\n      \n      // Create a test file\n      const testContent = 'This is a test document for loan application';\n      const testFilePath = path.join(__dirname, 'test-document.txt');\n      fs.writeFileSync(testFilePath, testContent);\n      \n      const formData = new FormData();\n      formData.append('document', fs.createReadStream(testFilePath));\n      \n      const response = await axios.post(\n        `${API_BASE}/loans/applications/${this.applicationId}/documents/identity`,\n        formData,\n        {\n          headers: {\n            'Authorization': `Bearer ${this.token}`,\n            ...formData.getHeaders()\n          }\n        }\n      );\n      \n      console.log('âœ… Document uploaded successfully');\n      console.log('   Document ID:', response.data.data.id);\n      \n      // Clean up test file\n      fs.unlinkSync(testFilePath);\n      return true;\n    } catch (error) {\n      console.error('âŒ Document upload failed:', error.response?.data?.message || error.message);\n      return false;\n    }\n  }\n\n  async testGetApplication() {\n    try {\n      console.log('\\nğŸ“‹ Testing get application...');\n      const response = await axios.get(\n        `${API_BASE}/loans/applications/${this.applicationId}`,\n        { headers: this.getHeaders() }\n      );\n      \n      console.log('âœ… Application retrieved successfully');\n      console.log('   Application Number:', response.data.data.application.applicationNumber);\n      console.log('   Status:', response.data.data.application.status);\n      console.log('   Documents:', response.data.data.documents.length);\n      return true;\n    } catch (error) {\n      console.error('âŒ Get application failed:', error.response?.data?.message || error.message);\n      return false;\n    }\n  }\n\n  async testGetAllApplications() {\n    try {\n      console.log('\\nğŸ“‹ Testing get all applications...');\n      const response = await axios.get(\n        `${API_BASE}/loans/applications`,\n        { headers: this.getHeaders() }\n      );\n      \n      console.log('âœ… Applications list retrieved successfully');\n      console.log('   Total applications:', response.data.data.length);\n      return true;\n    } catch (error) {\n      console.error('âŒ Get applications failed:', error.response?.data?.message || error.message);\n      return false;\n    }\n  }\n\n  async testSaveDraft() {\n    try {\n      console.log('\\nğŸ’¾ Testing save draft...');\n      const draftData = {\n        ...testApplication,\n        applicant: {\n          ...testApplication.applicant,\n          firstName: 'Jane' // Updated name\n        }\n      };\n      \n      const response = await axios.post(\n        `${API_BASE}/loans/applications/${this.applicationId}/save-draft`,\n        draftData,\n        { headers: this.getHeaders() }\n      );\n      \n      console.log('âœ… Draft saved successfully');\n      return true;\n    } catch (error) {\n      console.error('âŒ Save draft failed:', error.response?.data?.message || error.message);\n      return false;\n    }\n  }\n\n  async testSubmitApplication() {\n    try {\n      console.log('\\nğŸš€ Testing application submission...');\n      const response = await axios.post(\n        `${API_BASE}/loans/applications/${this.applicationId}/submit`,\n        {},\n        { headers: this.getHeaders() }\n      );\n      \n      console.log('âœ… Application submitted successfully');\n      console.log('   Status:', response.data.data.status);\n      console.log('   Submitted At:', response.data.data.submittedAt);\n      return true;\n    } catch (error) {\n      console.error('âŒ Application submission failed:', error.response?.data?.message || error.message);\n      return false;\n    }\n  }\n\n  async runAllTests() {\n    console.log('ğŸ§ª Starting Loan Application System Tests\\n');\n    \n    const results = {\n      login: false,\n      create: false,\n      update: false,\n      upload: false,\n      get: false,\n      getAll: false,\n      saveDraft: false,\n      submit: false\n    };\n\n    // Test login\n    results.login = await this.login();\n    if (!results.login) {\n      console.log('\\nâŒ Cannot proceed without login');\n      return results;\n    }\n\n    // Test create application\n    results.create = await this.testCreateApplication();\n    if (!results.create) {\n      console.log('\\nâŒ Cannot proceed without application creation');\n      return results;\n    }\n\n    // Test update application\n    results.update = await this.testUpdateApplication();\n\n    // Test document upload\n    results.upload = await this.testDocumentUpload();\n\n    // Test get application\n    results.get = await this.testGetApplication();\n\n    // Test get all applications\n    results.getAll = await this.testGetAllApplications();\n\n    // Test save draft\n    results.saveDraft = await this.testSaveDraft();\n\n    // Test submit application\n    results.submit = await this.testSubmitApplication();\n\n    // Print summary\n    console.log('\\nğŸ“Š Test Results Summary:');\n    console.log('========================');\n    Object.entries(results).forEach(([test, passed]) => {\n      console.log(`${passed ? 'âœ…' : 'âŒ'} ${test.padEnd(12)} ${passed ? 'PASSED' : 'FAILED'}`);\n    });\n\n    const passedTests = Object.values(results).filter(Boolean).length;\n    const totalTests = Object.keys(results).length;\n    console.log(`\\nğŸ¯ Overall: ${passedTests}/${totalTests} tests passed`);\n\n    return results;\n  }\n}\n\n// Run tests if this file is executed directly\nif (require.main === module) {\n  const tester = new LoanApplicationTester();\n  tester.runAllTests().catch(console.error);\n}\n\nmodule.exports = LoanApplicationTester;\n